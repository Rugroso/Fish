<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Fish</title>
    <style>
        canvas {
            border: 1px solid black;
        }
    </style>
</head>
<body>
    <div>
        <input type="number" name="roomIdSelector" id="roomIdSelector">
        <button onclick="selectRoom()">
            IR A LA SALA
        </button>
        <input type="text" name="nameChanger" id="nameChanger">
        <button onclick="changeName()">
            CAMBIAR NOMBRE
        </button>
        <input type="text" name="sendMessage" id="sendMessage">
        <button onclick="messageF()">
            ENVIAR MENSAJE
        </button>
    </div>
    <canvas id="gameCanvas" width="1200" height="800"></canvas>
    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let socket = new WebSocket('ws://192.168.10.146:3000');
        let otherPlayers = {};
        let playerId = Math.floor(Math.random()*10000);
        let dx;
        let dy;
        let angle;
        let angleDegrees;
        let anglemv;
        let angleDegreesmv;
        let roomId = 512;
        let name= playerId.toString();
        let message = "";
        let timeMessage = 0;
        let movement=false;

        const backgroundImage = new Image();
        backgroundImage.src = 'Fondo.jpg';
        const backgroundImage2 = new Image();
        backgroundImage2.src = 'Fondo2.jpg';

        //const fishImage = new Image();
        //fishImage.src = 'Sprite.png';

        //const fishImageRight = new Image();
        //fishImageRight.src = 'SpriteRight.png';


        const fishImage3dFront= new Image();
        fishImage3dFront.src = 'FishFront.png';

        const fishImage3dUp= new Image();
        fishImage3dUp.src = 'FishUp.png';
        
        const fishImage3dRight = new Image();
        fishImage3dRight.src = 'RightFish.png';
        
        const fishImage3dRightSideUp= new Image();
        fishImage3dRightSideUp.src = 'RightSideFishUp.png';

        const fishImage3dRightSideDown= new Image();
        fishImage3dRightSideDown.src = 'RightSideFishDown.png';

        const fishImage3dLeft = new Image();
        fishImage3dLeft.src = 'LeftFish.png';

        const fishImage3dLeftUp = new Image();
        fishImage3dLeftUp.src = 'LeftSideFishUp.png';

        const fishImage3dLeftDown = new Image();
        fishImage3dLeftDown.src = 'LeftSideFishDown.png';


        const mainSong = new Audio('fishMainMusic.mp3');
    
        socket.onopen = function() {
            console.log('Connected to the server');
            socket.send(JSON.stringify({ id: playerId, x: x, y: y, dy:dy, dx:dx, roomId:roomId, name:name, message:message, angleDegreesmv:angleDegreesmv}));
        };
        
        socket.onclose = function() {
            console.log("WebSocket connection closed unexpectedly.");
            setTimeout(function() {
                socket = new WebSocket('ws://192.168.10.146:3000');
                attachSocketHandlers();
            }, 1000); 
        };

        socket.onmessage = function(event) {
            const data = JSON.parse(event.data);
            if (data.id && data.id !== playerId) { 
                otherPlayers[data.id] = { x: data.x, y: data.y, dy:data.dy, dx:data.dx, roomId:data.roomId, name:data.name, message:data.message, angleDegreesmv:data.angleDegreesmv };
            }
        };
        
    
        socket.onerror = function(event) {
            console.error('WebSocket error:', event);
        };
        
        function sendMessage() {
            if (socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({ id: playerId, x: x, y: y }));
            } else if (socket.readyState === WebSocket.CONNECTING) {
                setTimeout(sendMessage, 100);
            } else {
                console.log("WebSocket is not open and cannot send messages:", socket.readyState);
            }
        }
                

        let x = 50;
        let y = 300;
        let xmv= 0;
        let ymv= 0;
        const speed = 5;
        let mouseX = x;
        let mouseY = y;
    
        canvas.addEventListener('click', function(event) {
            mouseX = event.clientX - canvas.offsetLeft;
            mouseY = event.clientY - canvas.offsetTop;
            mainSong.play().catch(e => console.error('Error playing the audio:', e));
        });

        canvas.addEventListener('mousemove', function (event) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            xmv = (event.clientX - rect.left) * scaleX;
            ymv = (event.clientY - rect.top) * scaleY;
        });
    
        function drawBackground() {
            ctx.drawImage(backgroundImage, 0, 0, canvas.width, canvas.height);
        }
        function drawBackground2() {
            ctx.drawImage(backgroundImage2, 0, 0, canvas.width, canvas.height);
        }
    
         function drawFish(x, y) {
            ctx.beginPath();
            ctx.fillStyle = 'black'
            ctx.font = "bold 20px serif";
            ctx.fillText(name,x+64,y+180);
            ctx.closePath();
            if (message!="" && timeMessage<=600) {
                //console.log(timeMessage)
                ctx.beginPath();
                ctx.fillStyle = 'rgba(256, 256, 256, 0.8)';
                ctx.fillRect(x+145, y-50, ctx.measureText(message).width+10, 50)
                ctx.fillStyle = 'black'
                ctx.fillText(message,x+151,y-20);
                ctx.closePath();
                timeMessage++;
            }
            if (timeMessage >600) {
                timeMessage = 0;
                message = "";
            }
            if(angleDegreesmv>-100 && angleDegreesmv<-80) { //arriba
                ctx.drawImage(fishImage3dUp, x, y);
             }
             if(angleDegreesmv<100 && angleDegreesmv>80) { //abajo
            ctx.drawImage(fishImage3dFront, x, y);
            }
            if(angleDegreesmv>-10 && angleDegreesmv<10) { //derecha
                 ctx.drawImage(fishImage3dRight, x, y);
            }
            if(angleDegreesmv>-80 && angleDegreesmv<-10) { //arriba derecha
                ctx.drawImage(fishImage3dRightSideUp, x, y);
           }
            if(angleDegreesmv<80 && angleDegreesmv>10) { //abajo derecha
                ctx.drawImage(fishImage3dRightSideDown, x, y);
           }
            if(angleDegreesmv<-170 || angleDegreesmv>170) { //izquierda
                ctx.drawImage(fishImage3dLeft, x, y);
            }
            if(angleDegreesmv>-170 && angleDegreesmv<-100) { //arriba izquierda
                ctx.drawImage(fishImage3dLeftUp, x, y);
            }
            if(angleDegreesmv<170 && angleDegreesmv>100) { //abajo izquierda
                ctx.drawImage(fishImage3dLeftDown, x, y);
            }
        }

        function drawOtherPlayers() {
            Object.values(otherPlayers).forEach(player => {
                //console.log(roomId)
                //console.log(player.roomId)
                if (roomId===player.roomId) {
                    ctx.font = "bold 20px serif";
                    ctx.fillText(player.name,player.x+64,player.y+180);
                    if (player.message!="") {
                        //console.log(timeMessage)
                        ctx.beginPath();
                        ctx.fillStyle = 'rgba(256, 256, 256, 0.8)';
                        ctx.fillRect(player.x+145, player.y-50, ctx.measureText(player.message).width+10, 50)
                        ctx.fillStyle = 'black'
                        ctx.fillText(player.message,player.x+151,player.y-20);
                        ctx.closePath();
                        timeMessage++;
                    }
                    anglePlayer = Math.atan2(player.dy, player.dx);
                    angleDegreesPlayer = anglePlayer * (180 / Math.PI);
                    //console.log(`player: ${player.dy}`)
                    if(player.angleDegreesmv>-100 && player.angleDegreesmv<-80) { //arriba
                        ctx.drawImage(fishImage3dUp, player.x, player.y);
                    }
                    if(player.angleDegreesmv<100 && player.angleDegreesmv>80) { //abajo
                    ctx.drawImage(fishImage3dFront, player.x, player.y);
                    }
                    if(player.angleDegreesmv>-10 && player.angleDegreesmv<10) { //derecha
                        ctx.drawImage(fishImage3dRight, player.x, player.y);
                    }
                    if(player.angleDegreesmv>-80 && player.angleDegreesmv<-10) { //arriba derecha
                        ctx.drawImage(fishImage3dRightSideUp, player.x, player.y);
                }
                    if(player.angleDegreesmv<80 && player.angleDegreesmv>10) { //abajo derecha
                        ctx.drawImage(fishImage3dRightSideDown, player.x, player.y);
                }
                    if(player.angleDegreesmv<-170 || player.angleDegreesmv>170) { //izquierda
                        ctx.drawImage(fishImage3dLeft, player.x, player.y);
                    }
                    if(player.angleDegreesmv>-170 && player.angleDegreesmv<-100) { //arriba izquierda
                        ctx.drawImage(fishImage3dLeftUp, player.x, player.y);
                    }
                    if(player.angleDegreesmv<170 && player.angleDegreesmv>100) { //abajo izquierda
                        ctx.drawImage(fishImage3dLeftDown, player.x, player.y);
                    }
            }
            });
        }

        function update() {
            dx = (mouseX-70) - x;
            dy = (mouseY-100) - y;
            angle = Math.atan2(dy, dx);
            angleDegrees = angle * (180 / Math.PI);
            //console.log(angleDegrees);
            console.log(`x: ${x} y: ${y} xmv: ${xmv} ymy: ${ymv} dx:${dx} dy:${dy}`)
            if (movement==false) {
                if (xmv < x+66 || xmv > x + 100 || ymv < y+80 || ymv > y + 102) {
                    dxmv = (xmv - 69) - x;
                    dymv = (ymv - 99) - y;
                    anglemv = Math.atan2(dymv, dxmv);
                    angleDegreesmv = anglemv * (180 / Math.PI);
                    //console.log(angleDegreesmv);
                }
            }
            
            let velocityX = Math.cos(angle) * speed;
            let velocityY = Math.sin(angle) * speed;
        
            if (Math.abs(dx) > speed || Math.abs(dy) > speed) {
                x += velocityX;
                y += velocityY;
            }

            if(x>1000 && y>600 && roomId===512) {
                x=100;
                y=100;
                mouseX=170;
                mouseY=200;
                roomId=206;
            }
            if(x<0 && y<0 && roomId===206) {
                x=1000;
                y=600;
                mouseX=1070;
                mouseY=700;
                roomId=512;
            } 

            socket.send(JSON.stringify({ id: playerId, x: x, y: y, dy:dy, dx:dx, roomId:roomId, name:name, message:message, angleDegreesmv:angleDegreesmv }));
        }
        
        function selectRoom() {
           let idRoom = document.getElementById('roomIdSelector').value;
           roomId = parseInt(idRoom, 10);
        }

        function changeName() {
            name = document.getElementById('nameChanger').value;
         }

         function messageF () {
            message = document.getElementById('sendMessage').value;
         }
    
        function gameLoop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (roomId===512) drawBackground(); 
            if (roomId===206) drawBackground2();
            update();
            drawOtherPlayers();
            drawFish(x, y);
            requestAnimationFrame(gameLoop);
        }

        ctx.fillRect(500, 300, 200, 200);
        setTimeout(function() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            mainSong.play();
            gameLoop();
        }, 2000); 
    </script>    
</body>
</html>