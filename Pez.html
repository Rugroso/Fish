<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Fish</title>
    <style>
        body {
            background-color: rgb(181, 239, 239);
            width: 100%;
            height: 100%;
        }
        #gameCanvas {
            border: 1px solid black;
            cursor: default;
        }
        #backgroundImg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1; 
        }
      
        #container {
            position: relative;
            width: 1200px; 
            height: 690px; 
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .posicionBotones {
        display: flex;
        justify-content: center;
        align-items: center;
        position: absolute; 
        width: 100%; 
        bottom: -170px; 
    }

        .posicionBotones button {
        background-color: #2f7cc8; 
        border: none;
        color: white;
        padding: 10px 30px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 14px;
        margin: 4px 2px;
        transition-duration: 0.4s;
        cursor: pointer;
        border-radius: 8px; 
        box-shadow: 0 4px #0056b3; 
        align-items: center;
        justify-content: center;
        }

    .posicionBotones button:hover {
        background-color: #0056b3; 
        box-shadow: 0 5px #003d7a; 
        color: #D0EFFF; 
    }

    .posicionBotones input[type="number"], .posicionBotones input[type="text"] {
        padding: 10px;
        margin: 4px 2px;
        border: 2px solid #007BFF; 
        border-radius: 4px; 
    }

        #juego {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .marco {
        position: absolute;
        pointer-events: none; 
        
        }

        .marcoArriba, .marcoAbajo, .marcoDerecha, .marcoIzquierda {
        position: absolute;
        width: auto; 
        height: auto; 
        }


        .marcoArriba {
            position: absolute;
        top: -345px;
        left: -600px;
        }

        .marcoAbajo {
        position: absolute;
        bottom: -345px;
        left: -600px;
        }

        .marcoDerecha {
        top: -345px;
        bottom: 0;
        right: -600px;
        }

        .marcoIzquierda {
        position: absolute;
        bottom: -345px;
        left: -600px;
        }

         

        

    </style>
</head>
<body>
    <img src="fish logo.png" alt="Logo del Juego" style="display: block; margin: 0 auto; width: 300px;"> 
    <div id="juego">
        <div id="container">
            <div class="marco">
                
                <img class="marcoDerecha" src="marco/marco der.png" alt="Marco Derecha">
                <img class="marcoIzquierda" src="marco/marco izq.png" alt="Marco Izquierda">
                <img class="marcoAbajo" src="marco/marco abajo.png" alt="Marco Abajo">
                <img class="marcoArriba" src="marco/marco arriba.png" alt="Marco Arriba">
                
            </div>

            <img id="backgroundImg" src="gif.gif" alt="Ocean Background">
            <canvas id="gameCanvas" width="1200" height="690"></canvas>
        </div>
    </div>
    <div class="posicionBotones">
        <input type="number" name="roomIdSelector" id="roomIdSelector">
        <button onclick="selectRoom()">
            IR A LA SALA
        </button>
        <input type="text" name="nameChanger" id="nameChanger">
        <button onclick="changeName()">
            CAMBIAR NOMBRE
        </button>
        <input type="text" name="sendMessage" id="sendMessage">
        <button onclick="messageF()">
            ENVIAR MENSAJE
        </button>
    </div>
        <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let socket = new WebSocket('ws://127.0.0.1:3000');
        let otherPlayers = {};
        let id = Math.floor(Math.random()*10000);
        let dx;
        let dy;
        let angle;
        let angleDegrees;
        let anglemv;
        let angleDegreesmv;
        let roomId = 512;
        let name= id.toString();
        let message = "";
        let timeMessage = 0;
        let movement=false;
        let allMouseX = -100;
        let allMouseY = -100;

        

        const backgroundImage2 = new Image();
        backgroundImage2.src = 'Fondo2.jpg';

        const backgroundImage3 = new Image();
        backgroundImage3.src = 'Cetys.jpg';

        const fishImage3dFront= new Image();
        fishImage3dFront.src = 'FishFront.png';

        const fishImage3dUp= new Image();
        fishImage3dUp.src = 'FishUp.png';
        
        const fishImage3dRight = new Image();
        fishImage3dRight.src = 'RightFish.png';
        
        const fishImage3dRightSideUp= new Image();
        fishImage3dRightSideUp.src = 'RightSideFishUp.png';

        const fishImage3dRightSideDown= new Image();
        fishImage3dRightSideDown.src = 'RightSideFishDown.png';

        const fishImage3dLeft = new Image();
        fishImage3dLeft.src = 'LeftFish.png';

        const fishImage3dLeftUp = new Image();
        fishImage3dLeftUp.src = 'LeftSideFishUp.png';

        const fishImage3dLeftDown = new Image();
        fishImage3dLeftDown.src = 'LeftSideFishDown.png';

        const mainSong = new Audio('fishMainMusic.mp3');
        mainSong.volume = 0.1;
        const chatSound = new Audio('chatSoundEffect.mp3');
        chatSound.volume = 1.0;
    
        socket.onopen = function() {
            console.log('Connected to the server');
            socket.send(JSON.stringify({ id: id, x: x, y: y, dy:dy, dx:dx, roomId:roomId, name:name, message:message, angleDegreesmv:angleDegreesmv, timeMessage:timeMessage}));
        };
        
        socket.onclose = function() {
            console.log("WebSocket connection closed unexpectedly.");
            setTimeout(function() {
                socket = new WebSocket('ws://10.4.80.109/:3000'); //Cambien esto por su direccion ip, les sale al abrir live server configurandolo para que abra un servidor en el LAN (area local), no cambien nada mas que solo la direccion el puerto (:3000 se queda igual)
                attachSocketHandlers();
            }, 1000); 
        };

        socket.onmessage = function(event) {
            const data = JSON.parse(event.data);
            if (data.id && data.id !== id) { 
                otherPlayers[data.id] = {id:data.id, x: data.x, y: data.y, dy:data.dy, dx:data.dx, roomId:data.roomId, name:data.name, message:data.message, angleDegreesmv:data.angleDegreesmv, timeMessage:data.timeMessage };
            }
        };
        
    
        socket.onerror = function(event) {
            console.error('WebSocket error:', event);
        };
        
        function sendMessage() {
            if (socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({ id: id, x: x, y: y }));
            } else if (socket.readyState === WebSocket.CONNECTING) {
                setTimeout(sendMessage, 100);
            } else {
                console.log("WebSocket is not open and cannot send messages:", socket.readyState);
            }
        }

        let x = 50;
        let y = 300;
        let xmv= 0;
        let ymv= 0;
        const speed = 8;
        let mouseX = x;
        let mouseY = y;
        
        function handleMouseClick(event) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
        
            mouseX = (event.clientX - rect.left) * scaleX;
            mouseY = (event.clientY - rect.top) * scaleY;
        
            mainSong.play().catch(e => console.error('Error playing the audio:', e));
        }
        

        function allTimeClick(event) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
        
            allMouseX = (event.clientX - rect.left) * scaleX;
            allMouseY = (event.clientY - rect.top) * scaleY;
        
            console.log (`clic en x: ${allMouseX} clic en y: ${allMouseY}`);
        }
        canvas.addEventListener('click', allTimeClick)

        canvas.addEventListener('mousemove', function (event) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            xmv = (event.clientX - rect.left) * scaleX;
            ymv = (event.clientY - rect.top) * scaleY;
        });
    
        function drawRoom512() {
           //ctx.drawImage(backgroundImage, 0, 0, canvas.width, canvas.height);
        }
        function drawRoom206() {
            ctx.drawImage(backgroundImage2, 0, 0, canvas.width, canvas.height);
        }
        function drawRoom0() {
            ctx.drawImage(backgroundImage3, 0, 0, canvas.width, canvas.height);
        }
    
         function drawFish(x, y) {
            ctx.beginPath();
            ctx.fillStyle = 'black'
            ctx.font = "bold 20px serif";
            ctx.fillText(name,x+64,y+180);
            ctx.closePath();
            if (message!="" && timeMessage<=180) {
                ctx.beginPath();
                ctx.fillStyle = 'rgba(256, 256, 256, 0.8)';
                ctx.fillRect(x+145, y-50, ctx.measureText(message).width+10, 50)
                ctx.fillStyle = 'black'
                ctx.fillText(message,x+151,y-20);
                ctx.closePath();
                console.log(timeMessage);
                timeMessage++;
            }
            if (timeMessage==1) {
                chatSound.play();
            }
            if (timeMessage>180) {
                timeMessage = 0;
                message = "";
            }
            if(angleDegreesmv>-100 && angleDegreesmv<-80) { //arriba
                ctx.drawImage(fishImage3dUp, x, y);
             }
             if(angleDegreesmv<100 && angleDegreesmv>80) { //abajo
            ctx.drawImage(fishImage3dFront, x, y);
            }
            if(angleDegreesmv>-10 && angleDegreesmv<10) { //derecha
                 ctx.drawImage(fishImage3dRight, x, y);
            }
            if(angleDegreesmv>-80 && angleDegreesmv<-10) { //arriba derecha
                ctx.drawImage(fishImage3dRightSideUp, x, y);
           }
            if(angleDegreesmv<80 && angleDegreesmv>10) { //abajo derecha
                ctx.drawImage(fishImage3dRightSideDown, x, y);
           }
            if(angleDegreesmv<-170 || angleDegreesmv>170) { //izquierda
                ctx.drawImage(fishImage3dLeft, x, y);
            }
            if(angleDegreesmv>-170 && angleDegreesmv<-100) { //arriba izquierda
                ctx.drawImage(fishImage3dLeftUp, x, y);
            }
            if(angleDegreesmv<170 && angleDegreesmv>100) { //abajo izquierda
                ctx.drawImage(fishImage3dLeftDown, x, y);
            }

            if (xmv > x && xmv < x + 200 && ymv > y+35 && ymv < y + 160) {
                document.getElementById('gameCanvas').style.cursor = 'pointer';
                selection=true;
                //console.log(angleDegreesmv);
            }
            if (selection) {
                canvas.removeEventListener('click', handleMouseClick) ;
            }
            if (!selection) {
                canvas.addEventListener('click', handleMouseClick);
            }

            if (allMouseX > x && allMouseX < x + 200 && allMouseY > y+35 && allMouseY < y + 160) {
                alert (`Te has autoclickeado!!`);
            }
        }

        let drawPosition=false;

        function drawOtherPlayers() {
            Object.values(otherPlayers).forEach(player => {
                //console.log(roomId)
                //console.log(player.roomId)
                if (roomId===player.roomId) {
                    ctx.font = "bold 20px serif";
                    ctx.fillText(player.name,player.x+64,player.y+180);
                    if (player.message!="") {
                        ctx.beginPath();
                        ctx.fillStyle = 'rgba(256, 256, 256, 0.8)';
                        ctx.fillRect(player.x+145, player.y-50, ctx.measureText(player.message).width+10, 50)
                        ctx.fillStyle = 'black'
                        ctx.fillText(player.message,player.x+151,player.y-20);
                        ctx.closePath();
                    }
                    if (player.timeMessage == 1) {
                        chatSound.play().catch(e => console.error('Error playing the audio:', e));;
                    }
                    anglePlayer = Math.atan2(player.dy, player.dx);
                    angleDegreesPlayer = anglePlayer * (180 / Math.PI);
                    //console.log(`player: ${player.dy}`)
                    if(player.angleDegreesmv>-100 && player.angleDegreesmv<-80) { //arriba
                        ctx.drawImage(fishImage3dUp, player.x, player.y);
                    }
                    if(player.angleDegreesmv<100 && player.angleDegreesmv>80) { //abajo
                    ctx.drawImage(fishImage3dFront, player.x, player.y);
                    }
                    if(player.angleDegreesmv>-10 && player.angleDegreesmv<10) { //derecha
                        ctx.drawImage(fishImage3dRight, player.x, player.y);
                    }
                    if(player.angleDegreesmv>-80 && player.angleDegreesmv<-10) { //arriba derecha
                        ctx.drawImage(fishImage3dRightSideUp, player.x, player.y);
                    }
                    if(player.angleDegreesmv<80 && player.angleDegreesmv>10) { //abajo derecha
                        ctx.drawImage(fishImage3dRightSideDown, player.x, player.y);
                    }
                    if(player.angleDegreesmv<-170 || player.angleDegreesmv>170) { //izquierda
                        ctx.drawImage(fishImage3dLeft, player.x, player.y);
                    }
                    if(player.angleDegreesmv>-170 && player.angleDegreesmv<-100) { //arriba izquierda
                        ctx.drawImage(fishImage3dLeftUp, player.x, player.y);
                    }
                    if(player.angleDegreesmv<170 && player.angleDegreesmv>100) { //abajo izquierda
                        ctx.drawImage(fishImage3dLeftDown, player.x, player.y);
                    }
                    if (xmv > player.x && xmv < player.x + 200 && ymv > player.y+35 && ymv < player.y + 160) {
                        document.getElementById('gameCanvas').style.cursor = 'pointer';
                        selection=true;
                    }
                    if (selection) {
                        canvas.removeEventListener('click', handleMouseClick) ;
                    }
                    if (!selection) {
                        canvas.addEventListener('click', handleMouseClick);
                    }
        
                    if (allMouseX > player.x && allMouseX < player.x + 200 && allMouseY > player.y+35 && allMouseY < player.y + 160) {
                        alert (`has dado clic sobre el jugador con id ${player.id}`);
                    }
            }
            });
        }

        let selection = false;

        function update() {
            dx = (mouseX-70) - x;
            dy = (mouseY-100) - y;
            angle = Math.atan2(dy, dx);
            angleDegrees = angle * (180 / Math.PI);
            //console.log(angleDegrees);
            //console.log(`x: ${x} y: ${y} xmv: ${xmv} ymy: ${ymv} dx:${dx} dy:${dy}`)
            if (xmv < x+60 || xmv > x + 100 || ymv < y+80 || ymv > y + 102) {
                dxmv = (xmv - 69) - x;
                dymv = (ymv - 99) - y;
                anglemv = Math.atan2(dymv, dxmv);
                angleDegreesmv = anglemv * (180 / Math.PI);
                document.getElementById('gameCanvas').style.cursor = 'default';
                selection=false;
                //console.log(angleDegreesmv);
            }

            let velocityX = Math.cos(angle) * speed;
            let velocityY = Math.sin(angle) * speed;
        
            if (Math.abs(dx) > speed || Math.abs(dy) > speed) {
                x += velocityX;
                y += velocityY;
            }

            if(x>1000 && y>600 && roomId===512) { //cambio de roomId en la sala principal
                x=100;
                y=100;
                mouseX=170;
                mouseY=200;
                roomId=206;
            }
            
            if(x<0 && y<0 && roomId===206) { //cambio de roomId en la sala 206
                x=1000;
                y=600;
                mouseX=1070;
                mouseY=700;
                roomId=512;
            }
            //Dibujo de sala actual
            if (roomId===512) drawRoom512();
            if (roomId===206) drawRoom206();
            if (roomId===0) drawRoom0();
            socket.send(JSON.stringify({ id: id, x: x, y: y, dy:dy, dx:dx, roomId:roomId, name:name, message:message, angleDegreesmv:angleDegreesmv, timeMessage:timeMessage }));
        }
        
        function selectRoom() {
           let idRoom = document.getElementById('roomIdSelector').value;
           roomId = parseInt(idRoom, 10);
        }

        function changeName() {
            name = document.getElementById('nameChanger').value;
         }

         function messageF () {
            message = document.getElementById('sendMessage').value;
            timeMessage=0;
         }
         let lastFrameTime
        lastFrameTime = Date.now();
         const frameRate = 1000 / 60;
        let xgpx = 0;
        let ygpx = 400;
        let speedg = 1;
         function gameLoop() {
             const now = Date.now();
             const deltaTime = now - lastFrameTime;
             if (deltaTime >= frameRate) {
                if (roomId!=1) speedg = 1; //Esto reinicia la velocidad del cuadro cada que sales del minijuego
                if (roomId==1) { //MINIJUEGO 1, The 10px Game
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    socket.send(JSON.stringify({ id: id, x: x, y: y, dy:dy, dx:dx, roomId:roomId, name:name, message:message, angleDegreesmv:angleDegreesmv, timeMessage:timeMessage }));
                    canvas.removeEventListener('click', handleMouseClick) ;
                    x=-500;
                    y=-500;
                    mouseY = -400;
                    mouseX = -430;
                    xgpx+=speedg;
                    ctx.fillRect(xgpx,ygpx,10,10)
                    if(xgpx>1200){
                        xgpx=0;
                    }
                    if (allMouseX > xgpx && allMouseX < xgpx+10 && allMouseY > ygpx && allMouseY < ygpx+10) {
                        alert('Has ganado!!')
                        allMouseX = -500;
                        allMouseY = -500;
                        speedg++;
                    }
                }
                if (roomId==2) { 
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    socket.send(JSON.stringify({ id: id, x: x, y: y, dy:dy, dx:dx, roomId:roomId, name:name, message:message, angleDegreesmv:angleDegreesmv, timeMessage:timeMessage }));
                    canvas.removeEventListener('click', handleMouseClick) ;
                    x=-500;
                    y=-500;
                    mouseX = -400;
                    mouseY = -430;
                }
                if (roomId==3) {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    socket.send(JSON.stringify({ id: id, x: x, y: y, dy:dy, dx:dx, roomId:roomId, name:name, message:message, angleDegreesmv:angleDegreesmv, timeMessage:timeMessage }));
                    canvas.removeEventListener('click', handleMouseClick) ;
                    x=-500;
                    y=-500;
                    mouseX = -400;
                    mouseY = -430;
                }
                if (roomId!=1 && roomId !=2 && roomId !=3) { // Las 3 salas representan 3 juegos dentro de Fish que no involucran el uso de los peces y el update es distinto
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    update();
                    drawOtherPlayers();
                    drawFish(x, y);
                    allMouseX = -1000;
                    allMouseY = -1000;
                    if (x<-300 || x<-300) {
                        x=400;
                        y=400;
                        mouseX=470;
                        mouseY=500;
                    }
                }
                lastFrameTime = now - (deltaTime % frameRate);
             }
             requestAnimationFrame(gameLoop);
         }
        ctx.fillRect(500, 300, 200, 200);
        setTimeout(function() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            mainSong.play();
            gameLoop();
        }, 2000); 
    </script>    
</body>
</html>